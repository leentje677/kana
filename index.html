<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Japanese Kana Practice</title>
    <script src="kana-data.js?v=1.1"></script>
    <style>
        :root {
            --bg: #FFFFFF; --text: #4B4B4B; --primary: #58CC02;
            --secondary: #1CB0F6; --wrong: #FF4B4B; --hint: #AFAFAF;
            --entry-bg: #F7F7F7; --progress-bg: #E5E5E5;
            --next-btn: #1CB0F6;
        }
        body.dark-mode {
            --bg: #131F24; --text: #E5E5E5; --entry-bg: #202F36;
            --progress-bg: #37464F; --hint: #777;
        }
        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg); color: var(--text);
            display: flex; justify-content: center; align-items: center;
            min-height: 100vh; margin: 0; transition: background-color 0.3s;
        }
        .container { 
            width: 450px; 
            max-width: 95%; 
            text-align: center; 
            padding: 25px; 
            box-sizing: border-box;
        }
        .menu-area { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
        .top-row { display: flex; justify-content: space-between; align-items: center; }
        .settings-row { display: flex; justify-content: space-around; font-size: 12px; background: var(--entry-bg); padding: 10px; border-radius: 12px; }
        
        select, input[type="text"] { padding: 12px; border-radius: 12px; border: 2px solid var(--progress-bg); outline: none; background-color: var(--entry-bg); color: var(--text); }
        select { background-color: var(--secondary); color: white; font-weight: bold; border: none; cursor: pointer; }
        
        .progress-container { width: 100%; background-color: var(--progress-bg); height: 14px; border-radius: 7px; margin-bottom: 10px; overflow: hidden; }
        #progress-bar { width: 0%; height: 100%; background-color: var(--primary); transition: width 0.3s; }
        
        #timer-display { font-weight: bold; color: var(--wrong); font-size: 20px; height: 24px; margin-bottom: 5px; }
        
        #char-display { 
            font-size: 70px; 
            font-weight: bold; 
            color: var(--primary); 
            margin: 15px 0; 
            min-height: 100px; 
            cursor: pointer;
            word-wrap: break-word;
            line-height: 1.2;
        }
        
        #user-input { width: 90%; font-size: 22px; text-align: center; margin-bottom: 20px; }
        
        .buttons { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }
        button { padding: 14px 24px; border: none; border-radius: 14px; font-weight: bold; cursor: pointer; transition: transform 0.1s, opacity 0.2s; font-size: 16px; }
        button:active { transform: scale(0.98); }

        #btn-check { background-color: var(--primary); color: white; }
        #btn-hint { background-color: var(--progress-bg); color: var(--hint); }
        #btn-slow { background-color: #FF9600; color: white; }
        #btn-next { background-color: var(--next-btn); color: white; display: none; width: 100%; max-width: 200px; }
        
        #result-text { 
            margin-top: 20px; 
            font-weight: bold; 
            min-height: 60px; 
            font-size: 18px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center;
            gap: 5px;
            padding: 0 10px;
        }
        
        .stats { margin-top: 25px; font-size: 14px; color: var(--hint); border-top: 1px solid var(--progress-bg); padding-top: 15px; }
    </style>
</head>
<body>

<div class="container">
    <div class="menu-area">
        <div class="top-row">
            <select id="mode-select"></select>
            <button id="btn-dark-mode">üåô</button>
        </div>
        <div class="settings-row">
            <label><input type="checkbox" id="sound-toggle"> Audio</label>
            <label><input type="checkbox" id="timer-toggle"> Timer</label>
            <label><input type="checkbox" id="endless-toggle"> Endless</label>
        </div>
    </div>
    <div id="timer-display"></div>
    <div class="progress-container"><div id="progress-bar"></div></div>
    <h2 id="title-text" style="font-size: 18px; margin: 0;">What is this?</h2>
    <div id="char-display" title="Click to hear sound">...</div>
    <input type="text" id="user-input" placeholder="Type romaji..." autocomplete="off">
    <div class="buttons" id="quiz-buttons">
        <button id="btn-check">CHECK</button>
        <button id="btn-hint">HINT</button>
        <button id="btn-slow">üêå SLOW</button> 
        <button id="btn-next">NEXT ‚Üí</button>
    </div>
    <div id="result-text"></div>
    <div class="stats">
        <div id="stat-count">0 left</div>
        <div id="accuracy-label">Accuracy: 0%</div>
    </div>
</div>

<script>
    let currentData = {}, charsToTest = [], currentChar = "";
    let totalInDeck = 0, totalCorrect = 0, totalAttempts = 0;
    let isWaitingForNext = false, timeLeft = 60, timerInterval = null;

    const modeSelect = document.getElementById('mode-select');
    const charDisplay = document.getElementById('char-display');
    const userInput = document.getElementById('user-input');
    const resultText = document.getElementById('result-text');
    const btnCheck = document.getElementById('btn-check');
    const btnNext = document.getElementById('btn-next');
    const btnHint = document.getElementById('btn-hint');
    const btnSlow = document.getElementById('btn-slow');

    function playAudio(text, halfSpeed = false) {
        if (!document.getElementById('sound-toggle').checked) return;
        window.speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'ja-JP';
        utterance.rate = halfSpeed ? 0.4 : 0.9;
        window.speechSynthesis.speak(utterance);
    }

    function init() {
        if (typeof MODES === 'undefined') {
            setTimeout(init, 100);
            return;
        }
        let mixed = {};
        Object.keys(MODES).forEach(key => {
            Object.assign(mixed, MODES[key]);
        });
        MODES["Mixed / All"] = mixed;
        modeSelect.innerHTML = "";
        Object.keys(MODES).forEach(m => {
            let opt = document.createElement('option');
            opt.value = m; opt.innerText = m;
            modeSelect.appendChild(opt);
        });
        resetSession();
    }

    function resetSession() {
        clearInterval(timerInterval);
        currentData = MODES[modeSelect.value];
        charsToTest = Object.keys(currentData).sort(() => Math.random() - 0.5);
        totalInDeck = charsToTest.length;
        totalCorrect = 0; totalAttempts = 0;
        document.getElementById('accuracy-label').innerText = `Accuracy: 0%`;
        if (document.getElementById('timer-toggle').checked) {
            timeLeft = 60;
            document.getElementById('timer-display').innerText = `Time: ${timeLeft}s`;
            timerInterval = setInterval(() => {
                timeLeft--;
                document.getElementById('timer-display').innerText = `Time: ${timeLeft}s`;
                if (timeLeft <= 0) finishQuiz("Time's Up!");
            }, 1000);
        } else {
            document.getElementById('timer-display').innerText = "";
        }
        nextQuestion();
    }

    function nextQuestion() {
        isWaitingForNext = false;
        resultText.innerText = "";
        userInput.value = "";
        userInput.disabled = false;
        userInput.style.display = "inline-block";
        userInput.focus();
        btnCheck.style.display = "inline-block";
        btnHint.style.display = "inline-block";
        btnSlow.style.display = "inline-block";
        btnNext.style.display = "none";

        if (charsToTest.length === 0) {
            if (document.getElementById('endless-toggle').checked) {
                charsToTest = Object.keys(currentData).sort(() => Math.random() - 0.5);
            } else {
                finishQuiz("Mode Complete!");
                return;
            }
        }

        currentChar = charsToTest.pop();
        charDisplay.innerText = currentChar;
        
        if (currentChar.length > 5) {
            charDisplay.style.fontSize = "40px";
        } else if (currentChar.length > 3) {
            charDisplay.style.fontSize = "55px";
        } else {
            charDisplay.style.fontSize = "80px";
        }
        
        playAudio(currentChar);
        const remaining = charsToTest.length + 1;
        document.getElementById('progress-bar').style.width = `${((totalInDeck - remaining) / totalInDeck) * 100}%`;
        document.getElementById('stat-count').innerText = `${remaining} left`;
    }

    function checkAnswer() {
        if (isWaitingForNext || !currentChar) return;
        const val = userInput.value.toLowerCase().trim();
        if (!val) return;
        
        totalAttempts++;
        let correctDataEntry = currentData[currentChar];
        let possibleAnswers = [];

        // Support both single strings and arrays of correct answers
        if (Array.isArray(correctDataEntry)) {
            possibleAnswers = correctDataEntry.map(s => s.split(' (')[0].toLowerCase().trim());
        } else {
            possibleAnswers = [correctDataEntry.split(' (')[0].toLowerCase().trim()];
        }

        // Logic to allow 'm' instead of 'n' before p/b/m sounds
        let fuzzyAnswers = [...possibleAnswers];
        possibleAnswers.forEach(ans => {
            if (ans.includes('np')) fuzzyAnswers.push(ans.replace('np', 'mp'));
            if (ans.includes('nb')) fuzzyAnswers.push(ans.replace('nb', 'mb'));
            if (ans.includes('nm')) fuzzyAnswers.push(ans.replace('nm', 'mm'));
        });

        if (fuzzyAnswers.includes(val)) {
            totalCorrect++;
            resultText.style.color = "#58CC02";
            const primaryDisplay = Array.isArray(correctDataEntry) ? correctDataEntry[0] : correctDataEntry;
            resultText.innerHTML = `<div>Correct! ‚úÖ</div><div style="font-size: 14px; opacity: 0.8">${primaryDisplay}</div>`;
        } else {
            resultText.style.color = "#FF4B4B";
            const primaryDisplay = Array.isArray(correctDataEntry) ? correctDataEntry[0] : correctDataEntry;
            resultText.innerHTML = `<div>Incorrect!</div><div style="font-size: 14px; opacity: 0.8">It was: ${primaryDisplay}</div>`;
            charsToTest.unshift(currentChar); 
        }
        
        const acc = Math.round((totalCorrect / totalAttempts) * 100);
        document.getElementById('accuracy-label').innerText = `Accuracy: ${acc}%`;

        isWaitingForNext = true;
        userInput.disabled = true;
        btnCheck.style.display = "none";
        btnHint.style.display = "none";
        btnSlow.style.display = "none";
        btnNext.style.display = "inline-block";
        btnNext.focus();
    }

    function finishQuiz(msg) {
        clearInterval(timerInterval);
        charDisplay.innerText = "üèÅ";
        charDisplay.style.fontSize = "80px";
        resultText.innerText = msg;
        userInput.style.display = "none";
        btnCheck.style.display = "none";
        btnNext.style.display = "none";
        btnHint.style.display = "none";
        btnSlow.style.display = "none";
    }

    btnCheck.addEventListener('click', checkAnswer);
    btnNext.addEventListener('click', nextQuestion);
    btnSlow.addEventListener('click', () => playAudio(currentChar, true));
    charDisplay.addEventListener('click', () => playAudio(currentChar));

    userInput.addEventListener('keypress', (e) => { 
        if (e.key === 'Enter' && !isWaitingForNext) checkAnswer();
    });

    window.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && isWaitingForNext) nextQuestion();
    });

    modeSelect.addEventListener('change', resetSession);
    
    document.getElementById('btn-hint').addEventListener('click', () => {
        let hintData = currentData[currentChar];
        if (Array.isArray(hintData)) hintData = hintData.join(' or ');
        const hint = hintData.split('(')[1]?.replace(')', '') || "No hint";
        resultText.style.color = "#F89E1B";
        resultText.innerText = `Hint: ${hint}`;
    });

    document.getElementById('btn-dark-mode').addEventListener('click', () => {
        document.body.classList.toggle('dark-mode');
    });

    window.onload = init;    
</script>
</body>
</html>


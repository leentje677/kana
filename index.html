<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kana - Japanese Learning</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="kana-data.js?v=1.1"></script>
    <style>
        :root {
            --bg: #F0F4F2;
            --card-bg: rgba(255, 255, 255, 0.95);
            --text: #445D52;
            --text-secondary: #7A968A;
            --primary: #58A68A; 
            --secondary: #84B8A5;
            --wrong: #FF6B6B;
            --hint-color: #E67E22;
            --progress-bg: #E0EADE;
            --entry-bg: #F9FBFB;
            --shadow: 0 10px 30px rgba(0,0,0,0.15);
        }

        body.dark-mode {
            --bg: #1A2621;
            --card-bg: rgba(36, 52, 46, 0.95);
            --text: #E0EADE;
            --text-secondary: #A4BDB2;
            --entry-bg: #2C3E36;
            --progress-bg: #37464F;
            --shadow: 0 10px 30px rgba(0,0,0,0.4);
        }

        body {
            font-family: 'Nunito', sans-serif;
            /* Implementation of the sharp background from index test.html */
            background: url('kana.png') no-repeat center center fixed;
            background-size: cover;
            color: var(--text);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            transition: background-color 0.3s ease;
        }

        .container {
            width: 100%;
            max-width: 480px;
            background: var(--card-bg);
            padding: 40px 30px;
            border-radius: 40px;
            box-shadow: var(--shadow);
            text-align: center;
            position: relative;
            /* Adding slight glass effect without blurring the background image */
            border: 1px solid rgba(255,255,255,0.2);
        }

        /* Header Area */
        .app-header { margin-bottom: 25px; }

        .logo {
            font-size: 32px;
            font-weight: 800;
            color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 5px;
        }

        /* Settings Card Style */
        .settings-panel {
            background: var(--entry-bg);
            border-radius: 20px;
            padding: 15px;
            margin-bottom: 25px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .setting-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 12px;
            font-weight: 700;
            color: var(--text-secondary);
        }

        .setting-item input { margin-bottom: 5px; cursor: pointer; }

        /* Mode Selection */
        .mode-row {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        select {
            flex-grow: 1;
            padding: 12px 20px;
            border-radius: 15px;
            border: 2px solid var(--progress-bg);
            background: var(--card-bg);
            color: var(--text);
            font-weight: 700;
            cursor: pointer;
            outline: none;
        }

        #btn-dark-mode {
            background: var(--entry-bg);
            border: none;
            border-radius: 15px;
            width: 45px;
            cursor: pointer;
            font-size: 18px;
        }

        /* Quiz Area */
        .progress-container {
            width: 100%;
            background-color: var(--progress-bg);
            height: 10px;
            border-radius: 10px;
            margin-bottom: 30px;
            overflow: hidden;
        }

        #progress-bar {
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        #timer-display {
            font-weight: 800;
            color: var(--wrong);
            margin-bottom: 10px;
            height: 20px;
        }

        #char-display {
            font-size: 85px;
            font-weight: 700;
            color: var(--primary);
            margin: 20px 0;
            min-height: 120px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        #char-display:hover { transform: scale(1.05); }

        /* Interaction */
        #user-input {
            width: 100%;
            padding: 18px;
            border-radius: 20px;
            border: 3px solid var(--progress-bg);
            background: var(--entry-bg);
            color: var(--text);
            font-size: 24px;
            text-align: center;
            box-sizing: border-box;
            margin-bottom: 20px;
            transition: border-color 0.3s;
        }

        #user-input:focus { border-color: var(--primary); outline: none; }

        .button-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        button.main-btn {
            padding: 15px;
            border: none;
            border-radius: 18px;
            font-weight: 800;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }

        #btn-check { background: var(--primary); color: white; grid-column: span 2; }
        #btn-check:hover { filter: brightness(1.1); }
        #btn-hint { background: #FDF2E9; color: var(--hint-color); }
        #btn-slow { background: #EBF5FF; color: #3498DB; }
        
        #btn-next { 
            background: var(--primary); 
            color: white; 
            display: none; 
            grid-column: span 2;
        }

        #result-text {
            margin: 20px 0;
            min-height: 60px;
            font-weight: 700;
        }

        .stats-footer {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid var(--entry-bg);
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 600;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="app-header">
        <div class="logo">kana ü¶ä</div>
        <div style="font-size: 14px; opacity: 0.7;">Your Japanese journey continues</div>
    </div>

    <div class="mode-row">
        <select id="mode-select" title="Choose what you want to study"></select>
        <button id="btn-dark-mode" title="Toggle Light/Dark Theme">üåô</button>
    </div>

    <div class="settings-panel">
        <div class="setting-item" title="Hear the pronunciation automatically">
            <input type="checkbox" id="sound-toggle"> Audio
        </div>
        <div class="setting-item" title="60-second challenge mode">
            <input type="checkbox" id="timer-toggle"> Timer
        </div>
        <div class="setting-item" title="Keep going forever without stopping">
            <input type="checkbox" id="endless-toggle"> Endless
        </div>
    </div>

    <div id="timer-display"></div>
    <div class="progress-container"><div id="progress-bar"></div></div>
    
    <div id="char-display" title="Click to hear sound again">...</div>
    
    <input type="text" id="user-input" placeholder="Type romaji..." autocomplete="off">
    
    <div class="button-grid">
        <button id="btn-check" class="main-btn">CHECK ANSWER</button>
        <button id="btn-hint" class="main-btn" title="Show the meaning or a tip">üí° HINT</button>
        <button id="btn-slow" class="main-btn" title="Hear the sound slower"> snail SLOW</button> 
        <button id="btn-next" class="main-btn">NEXT CHARACTER ‚Üí</button>
    </div>

    <div id="result-text"></div>

    <div class="stats-footer">
        <div id="stat-count">0 left</div>
        <div id="accuracy-label">Accuracy: 0%</div>
    </div>
</div>

<script>
    let currentData = {}, charsToTest = [], currentChar = "";
    let totalInDeck = 0, totalCorrect = 0, totalAttempts = 0;
    let isWaitingForNext = false, timeLeft = 60, timerInterval = null;

    const modeSelect = document.getElementById('mode-select');
    const charDisplay = document.getElementById('char-display');
    const userInput = document.getElementById('user-input');
    const resultText = document.getElementById('result-text');
    const btnCheck = document.getElementById('btn-check');
    const btnNext = document.getElementById('btn-next');
    const btnHint = document.getElementById('btn-hint');
    const btnSlow = document.getElementById('btn-slow');

    function playAudio(text, halfSpeed = false) {
        if (!document.getElementById('sound-toggle').checked) return;
        window.speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'ja-JP';
        utterance.rate = halfSpeed ? 0.3 : 0.8;
        window.speechSynthesis.speak(utterance);
    }

    function init() {
        if (typeof MODES === 'undefined') {
            setTimeout(init, 100);
            return;
        }
        let mixed = {};
        Object.keys(MODES).forEach(key => {
            Object.assign(mixed, MODES[key]);
        });
        MODES["Mixed / All"] = mixed;
        modeSelect.innerHTML = "";
        Object.keys(MODES).forEach(m => {
            let opt = document.createElement('option');
            opt.value = m; opt.innerText = m;
            modeSelect.appendChild(opt);
        });
        resetSession();
    }

    function resetSession() {
        clearInterval(timerInterval);
        currentData = MODES[modeSelect.value];
        charsToTest = Object.keys(currentData).sort(() => Math.random() - 0.5);
        totalInDeck = charsToTest.length;
        totalCorrect = 0; totalAttempts = 0;
        document.getElementById('accuracy-label').innerText = `Accuracy: 0%`;
        
        if (document.getElementById('timer-toggle').checked) {
            timeLeft = 60;
            document.getElementById('timer-display').innerText = `‚è±Ô∏è ${timeLeft}s`;
            timerInterval = setInterval(() => {
                timeLeft--;
                document.getElementById('timer-display').innerText = `‚è±Ô∏è ${timeLeft}s`;
                if (timeLeft <= 0) finishQuiz("Time's Up!");
            }, 1000);
        } else {
            document.getElementById('timer-display').innerText = "";
        }
        nextQuestion();
    }

    function nextQuestion() {
        isWaitingForNext = false;
        resultText.innerText = "";
        userInput.value = "";
        userInput.disabled = false;
        userInput.style.display = "inline-block";
        userInput.focus();
        btnCheck.style.display = "inline-block";
        btnHint.style.display = "inline-block";
        btnSlow.style.display = "inline-block";
        btnNext.style.display = "none";

        if (charsToTest.length === 0) {
            if (document.getElementById('endless-toggle').checked) {
                charsToTest = Object.keys(currentData).sort(() => Math.random() - 0.5);
            } else {
                finishQuiz("Mode Complete! üéâ");
                return;
            }
        }

        currentChar = charsToTest.pop();
        charDisplay.innerText = currentChar;
        
        // Dynamic font resizing from main file
        if (currentChar.length > 5) {
            charDisplay.style.fontSize = "40px";
        } else if (currentChar.length > 3) {
            charDisplay.style.fontSize = "55px";
        } else {
            charDisplay.style.fontSize = "85px";
        }
        
        playAudio(currentChar);
        const remaining = charsToTest.length + 1;
        document.getElementById('progress-bar').style.width = `${((totalInDeck - remaining) / totalInDeck) * 100}%`;
        document.getElementById('stat-count').innerText = `${remaining} characters left`;
    }

    function checkAnswer() {
        if (isWaitingForNext || !currentChar) return;
        const val = userInput.value.toLowerCase().trim();
        if (!val) return;
        
        totalAttempts++;
        let correctDataEntry = currentData[currentChar];
        let possibleAnswers = [];

        if (Array.isArray(correctDataEntry)) {
            possibleAnswers = correctDataEntry.map(s => s.split(' (')[0].toLowerCase().trim());
        } else {
            possibleAnswers = [correctDataEntry.split(' (')[0].toLowerCase().trim()];
        }

        // Fuzzy logic from main file
        let fuzzyAnswers = [...possibleAnswers];
        possibleAnswers.forEach(ans => {
            if (ans.includes('np')) fuzzyAnswers.push(ans.replace('np', 'mp'));
            if (ans.includes('nb')) fuzzyAnswers.push(ans.replace('nb', 'mb'));
            if (ans.includes('nm')) fuzzyAnswers.push(ans.replace('nm', 'mm'));
        });

        if (fuzzyAnswers.includes(val)) {
            totalCorrect++;
            resultText.style.color = "var(--primary)";
            const primaryDisplay = Array.isArray(correctDataEntry) ? correctDataEntry[0] : correctDataEntry;
            resultText.innerHTML = `<div style="font-size: 20px;">Correct! ‚ú®</div><div style="font-size: 14px; opacity: 0.8">${primaryDisplay}</div>`;
        } else {
            resultText.style.color = "var(--wrong)";
            const primaryDisplay = Array.isArray(correctDataEntry) ? correctDataEntry[0] : correctDataEntry;
            resultText.innerHTML = `<div>Not quite...</div><div style="font-size: 14px; opacity: 0.8">It was: ${primaryDisplay}</div>`;
            charsToTest.unshift(currentChar); 
        }
        
        const acc = Math.round((totalCorrect / totalAttempts) * 100);
        document.getElementById('accuracy-label').innerText = `Accuracy: ${acc}%`;

        isWaitingForNext = true;
        userInput.disabled = true;
        btnCheck.style.display = "none";
        btnHint.style.display = "none";
        btnSlow.style.display = "none";
        btnNext.style.display = "inline-block";
        btnNext.focus();
    }

    function finishQuiz(msg) {
        clearInterval(timerInterval);
        charDisplay.innerText = "üèÅ";
        charDisplay.style.fontSize = "80px";
        resultText.innerText = msg;
        userInput.style.display = "none";
        btnCheck.style.display = "none";
        btnNext.style.display = "none";
        btnHint.style.display = "none";
        btnSlow.style.display = "none";
    }

    btnCheck.addEventListener('click', checkAnswer);
    btnNext.addEventListener('click', nextQuestion);
    btnSlow.addEventListener('click', () => playAudio(currentChar, true));
    charDisplay.addEventListener('click', () => playAudio(currentChar));

    userInput.addEventListener('keypress', (e) => { 
        if (e.key === 'Enter' && !isWaitingForNext) checkAnswer();
    });

    window.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && isWaitingForNext) nextQuestion();
    });

    modeSelect.addEventListener('change', resetSession);
    
    document.getElementById('btn-hint').addEventListener('click', () => {
        let hintData = currentData[currentChar];
        if (Array.isArray(hintData)) hintData = hintData.join(' or ');
        const hint = hintData.split('(')[1]?.replace(')', '') || "No extra hint available";
        resultText.style.color = "var(--hint-color)";
        resultText.innerText = `Hint: ${hint}`;
    });

    document.getElementById('btn-dark-mode').addEventListener('click', () => {
        document.body.classList.toggle('dark-mode');
        document.getElementById('btn-dark-mode').innerText = document.body.classList.contains('dark-mode') ? '‚òÄÔ∏è' : 'üåô';
    });

    window.onload = init;    
</script>
</body>
</html>

